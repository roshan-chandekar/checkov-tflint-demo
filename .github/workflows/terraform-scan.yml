name: Terraform Scan

on:
    push:
        branches:
            - main
            - dev
    workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        id: tflint
        run: |
          tflint --init
          # Using 'default' format for better suggestions than 'compact'
          REPORT=$(tflint -f default) || true
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run tfsec
        id: tfsec
        run: |
          # Install tfsec binary
          curl -sSLo ./tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64
          chmod +x ./tfsec
          # Run and capture JSON
          ./tfsec . --format json > tfsec_results.json || true
          
          # Parse counts using jq
          FAILED=$(jq '.results | map(select(.status=="fail")) | length' tfsec_results.json)
          PASSED=$(jq '.results | map(select(.status=="pass")) | length' tfsec_results.json)
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT

      - name: Run Checkov
        id: checkov
        run: |
          pip install checkov
          # Run checkov and ensure we get a clean JSON file
          checkov -d . --output json --soft-fail > checkov_results.json || true
          
          # This JQ filter handles both a single object or an array of results
          PASSED=$(jq '[. | if type=="array" then .[].summary.passed else .summary.passed end] | add' checkov_results.json)
          FAILED=$(jq '[. | if type=="array" then .[].summary.failed else .summary.failed end] | add' checkov_results.json)
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Post Summary Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const tflint = `${{ steps.tflint.outputs.stdout }}`;
            const tfsec_p = "${{ steps.tfsec.outputs.passed }}";
            const tfsec_f = "${{ steps.tfsec.outputs.failed }}";
            const checkov_p = "${{ steps.checkov.outputs.passed }}";
            const checkov_f = "${{ steps.checkov.outputs.failed }}";

            const body = `## ğŸ›¡ï¸ Infrastructure Scan Summary
            
            | Tool | Status | Passed âœ… | Failed âŒ |
            | :--- | :--- | :--- | :--- |
            | **tfsec** | ${parseInt(tfsec_f) > 0 ? 'âŒ Failed' : 'âœ… Passed'} | ${tfsec_p} | ${tfsec_f} |
            | **Checkov** | ${parseInt(checkov_f) > 0 ? 'âŒ Failed' : 'âœ… Passed'} | ${checkov_p} | ${checkov_f} |

            ### ğŸ” TFLint Suggestions
            \`\`\`text
            ${tflint}
            \`\`\`
            
            ---
            *Report generated by GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
