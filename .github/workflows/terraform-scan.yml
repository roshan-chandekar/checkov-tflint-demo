name: Terraform Scan

on:
    push:
        branches:
            - main
            - dev
    workflow_dispatch:
    
jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Required to post the comment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        id: tflint
        run: |
          tflint --init
          # Capture output, strip colors, and handle empty cases
          REPORT=$(tflint -f compact | sed 's/\x1b\[[0-9;]*m//g') || true
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "${REPORT:-âœ… No linting issues found.}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run tfsec
        id: tfsec
        run: |
          curl -sSLo ./tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64 && chmod +x ./tfsec
          ./tfsec . --format json > tfsec_results.json || true
          
          # Extraction with fallback to 0
          FAILED=$(jq '[.results[] | select(.status=="fail")] | length' tfsec_results.json || echo 0)
          PASSED=$(jq '[.results[] | select(.status=="pass")] | length' tfsec_results.json || echo 0)
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT

      - name: Run Checkov
        id: checkov
        run: |
          pip install checkov
          checkov -d . --output json --soft-fail > checkov_results.json || true
          
          # Robust JQ for multi-framework results
          PASSED=$(jq '[. | if type=="array" then .[].summary.passed else .summary.passed end] | add' checkov_results.json || echo 0)
          FAILED=$(jq '[. | if type=="array" then .[].summary.failed else .summary.failed end] | add' checkov_results.json || echo 0)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Post Summary Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tflint = `${{ steps.tflint.outputs.stdout }}`;
            const tfsec_f = parseInt("${{ steps.tfsec.outputs.failed }}") || 0;
            const checkov_f = parseInt("${{ steps.checkov.outputs.failed }}") || 0;

            const body = `## ğŸ›¡ï¸ Infrastructure Scan Summary
            
            | Tool | Status | Passed âœ… | Failed âŒ |
            | :--- | :--- | :--- | :--- |
            | **tfsec** | ${tfsec_f > 0 ? 'âŒ Failed' : 'âœ… Passed'} | ${{ steps.tfsec.outputs.passed }} | ${tfsec_f} |
            | **Checkov** | ${checkov_f > 0 ? 'âŒ Failed' : 'âœ… Passed'} | ${{ steps.checkov.outputs.passed }} | ${checkov_f} |

            ### ğŸ” TFLint Suggestions
            \`\`\`text
            ${tflint}
            \`\`\`
            
            ---
            *Report generated by GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
