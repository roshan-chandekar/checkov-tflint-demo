name: "Terraform Security Scan"

on:
  pull_request:
    branches: [ main, master, dev ]

# Production Best Practice: Stop old runs if a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform-scan:
    name: "Security & Linting Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- TFLint Setup with Caching ---
      - name: Cache TFLint Plugins
        uses: actions/cache@v4
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ runner.os }}-${{ hashFiles('.tflint.hcl') }}

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        id: tflint
        run: |
          tflint --init
          
          # Run TFLint and capture output.
          # [ $? -eq 2 ] ensures we don't fail the build if issues are found, 
          # but we do fail if there's a config error (exit code 1).
          REPORT=$(tflint -f compact | sed 's/\x1b\[[0-9;]*m//g') || [ $? -eq 2 ]
          
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "${REPORT:-‚úÖ No linting issues found.}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- tfsec Scan ---
      - name: Run tfsec
        id: tfsec
        run: |
          # Use the official binary to ensure version control
          curl -sSLo ./tfsec https://github.com/aquasecurity/tfsec/releases/download/v1.28.1/tfsec-linux-amd64 && chmod +x ./tfsec
          ./tfsec . --format json > tfsec_results.json || true
          
          echo "failed=$(jq '[.results[] | select(.status=="fail")] | length' tfsec_results.json || echo 0)" >> $GITHUB_OUTPUT
          echo "passed=$(jq '[.results[] | select(.status=="pass")] | length' tfsec_results.json || echo 0)" >> $GITHUB_OUTPUT

      # --- Checkov Scan ---
      - name: Run Checkov
        id: checkov
        run: |
          pip install checkov
          checkov --config-file .checkov.yml > checkov_results.json || true
          
          # Production JQ logic for multi-framework arrays
          PASSED=$(jq '[. | if type=="array" then .[].summary.passed else .summary.passed end] | add' checkov_results.json || echo 0)
          FAILED=$(jq '[. | if type=="array" then .[].summary.failed else .summary.failed end] | add' checkov_results.json || echo 0)
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      # --- PR Commenting ---
      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tflint = `${{ steps.tflint.outputs.stdout }}`;
            const tfsec_f = parseInt("${{ steps.tfsec.outputs.failed }}") || 0;
            const checkov_f = parseInt("${{ steps.checkov.outputs.failed }}") || 0;
            
            const body = `## üõ°Ô∏è Production Security Scan Results
            
            | Tool | Status | Passed ‚úÖ | Failed ‚ùå |
            | :--- | :--- | :--- | :--- |
            | **tfsec** | ${tfsec_f > 0 ? 'üî¥ High Risk' : 'üü¢ Secure'} | ${{ steps.tfsec.outputs.passed }} | ${tfsec_f} |
            | **Checkov** | ${checkov_f > 0 ? 'üî¥ High Risk' : 'üü¢ Secure'} | ${{ steps.checkov.outputs.passed }} | ${checkov_f} |

            ### üîç TFLint Suggestions
            \`\`\`text
            ${tflint}
            \`\`\`
            
            ---
            _Results generated automatically for commit ${context.sha}_`;

            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
